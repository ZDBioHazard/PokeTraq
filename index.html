<!DOCTYPE html>
<html><head>
    <title>Pok&eacute;Traq</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- FontAwesome -->
    <link rel="stylesheet" href="//unpkg.com/font-awesome@4.6.3/css/font-awesome.min.css" />
    <!-- Leaflet -->
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <script src="//unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <!-- Leaflet EasyButton -->
    <link rel="stylesheet" href="//unpkg.com/leaflet-easybutton@1.3.1/src/easy-button.css" />
    <script src="//unpkg.com/leaflet-easybutton@1.3.1/src/easy-button.js"></script>
    <!-- Leaflet Locate Control -->
    <link rel="stylesheet" href="//unpkg.com/leaflet.locatecontrol@0.55.0/dist/L.Control.Locate.min.css" />
    <script src="//unpkg.com/leaflet.locatecontrol@0.55.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <!-- Leaflet Modal -->
    <link rel="stylesheet" href="//unpkg.com/leaflet-modal@0.1.3/dist/leaflet.modal.min.css" />
    <script src="//unpkg.com/leaflet-modal@0.1.3/dist/Leaflet.Modal.min.js"></script>
    <!-- Turf -->
    <script src="//unpkg.com/@turf/turf@3.5.2/turf.min.js"></script>

    <style type="text/css">
        html, body, #map {
            margin: 0;
            padding: 0;

            width: 100vw;
            height: 100vh;

            font-size: 12pt;
            line-height: 1.25em;
        }

        #about-dialog { display: none; }

        .modal-content #about-dialog { display: block; }

        .modal-content h1 { text-align: center; }

        .state-far { color: #F00; }
        .state-near { color: #0F0; }
        .state-about { color: #00F; }
        .state-place { color: #00F; }

        /* Make the Easy Button buttons bigger so you can easily hit them on tiny phones. */
        .easy-button-container .easy-button-button {
            min-width: 0.5in;
            min-height: 0.5in;
            font-size: 0.4in;
            padding: 0.04in;
        }
    </style>
</head><body>
    <div id="map"></div>
    <div id="about-dialog">
        <h1>Pok&eacute;Traq</h1>
        <p>Click on the map to place markers that signify "nearby" and "too far" to
           help narrow down the possible location of whatever \'mon you\'re hunting.</p>

        <hr />

        <ul>
            <li>Green markers (<span class="fa fa-check-circle-o state-near"></span>)
                signify locations something appears on the "sightings" list.</li>
            <li>Red markers (<span class="fa fa-times-circle-o state-far"></span>)
                signify locations something is not in the "sightings" list.</li>
            <li>You can click on a placed marker to remove it.</li>
        </ul>

        <p>A blue area will be created around the locations where the
           target Pok&eacute;mon could be, based on your markers.</p>

        <hr />

        <h2>Buttons</h2><ul>
            <li><span class="fa fa-trash state-clear"></span> Remove all markers.</li>
            <li><span class="fa fa-check-circle-o state-near"></span> /
                <span class="fa fa-times-circle-o state-far"></span> Change marker type.</li>
            <li><span class="fa fa-arrow-circle-o-down state-place"></span> Place a marker at your location.</li>
        </ul>

        <hr />

        <p>If you like this app, please consider
           <a target="_blank" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=2UAG73LMY5LE2">making a donation</a>
           so I can buy some bag upgrades. :)</p>
        <p><a target="_blank" href="https://github.com/ZDBiohazard/PokeTraq">This app is open-source</a>,
           in case you want to contribute.</p>
    </div>
    <script>
    // Create a Leaflet map using OpenStreetMap data.
    var map = L.map('map', { center: [35.377, -119.008], zoom: 16, layers: [
        L.tileLayer('//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map by <a href="http://openstreetmap.org">OpenStreetMap</a>',
            minZoom: 5, maxZoom: 17 })] });
    var points = {
        near: L.layerGroup().addTo(map),
        far: L.layerGroup().addTo(map)
    };
    var area = L.layerGroup().addTo(map);
    var me = L.layerGroup().addTo(map);
    var marker_mode = 'near';

    // Automatically find the user's location on startup.
    L.control.locate({ setView: 'untilPan', icon: 'fa fa-crosshairs',
                       drawMarker: false, drawCircle: false,
                       locateOptions: { maxZoom: 16 }}).addTo(map).start();
    map.on('locationfound', function( ev ) {
        me.clearLayers();
        // Location accuracy circle.
        L.circle(ev.latlng, { radius: ev.accuracy / 2, stroke: 0, color: '#FFF' }).addTo(me);
        // Sightings range circle.
        L.circle(ev.latlng, { radius: 200, color: '#08F', stroke: 0 }).addTo(me);
        // Visible Pokemon circle.
        L.circle(ev.latlng, { radius: 70, color: '#F80', stroke: 0 }).addTo(me);
        // Location dot.
        L.circleMarker(ev.latlng, { radius: 6, stroke: 0, fillOpacity: 1, color: "#FFF" }).addTo(me);
    });

    // Go through the markers and build an area map.
    function update_search_area( ) {
        var segments = 32;
        var combined = null;
        var near = points.near.getLayers();
        var far = points.far.getLayers();

        // Remove the existing area from the map.
        area.clearLayers();

        // Nothing will be visible if there are no near locations, so exit now.
        if ( near.length == 0 ) {
            return;
        }

        // Intersect the near locations.
        for ( var i = 0 ; i < near.length ; i++ ) {
            var circle = turf.circle(near[i].toGeoJSON(), 200, segments, 'meters');
            if ( i == 0 ) {
                combined = circle;
            } else {
                // FIXME - It's possible there are two separate spawns far
                //         enough away to interfere with this algorithm.
                var intersected = turf.intersect(combined, circle);
                if ( intersected != undefined ) {
                    combined = intersected;
                }
            }
            // Remove the visible area from near scans,
            // since you would have found it already.
            combined = turf.difference(combined, turf.circle(near[i].toGeoJSON(), 70, segments, 'meters'));
        }

        // Exclude the far locations. Much easier.
        for ( var i = 0 ; i < far.length ; i++ ) {
            combined = turf.difference(combined, turf.circle(far[i].toGeoJSON(), 200, segments, 'meters'));
        }

        // Add the calculated area to the map.
        L.geoJSON(combined).addTo(area);
    }

    // Create circles when the map is clicked on.
    map.on('click', function( ev ) {
        marker = L.circleMarker(ev.latlng, { radius: 20, stroke: 0, fillOpacity: 1 });

        // Remove markers when they are clicked on.
        marker.on('click', function ( ev ) {
            if ( points.near.hasLayer(ev.target) == true ) {
                points.near.removeLayer(ev.target);
            } else if ( points.far.hasLayer(ev.target) == true ) {
                points.far.removeLayer(ev.target);
            }

            update_search_area();

            // Prevent this click from propagating up to the map.
            L.DomEvent.stopPropagation(ev);
        });

        // Add the marker to a group.
        if ( marker_mode == 'near' ) {
            marker.setStyle({ color: '#0F0' });
            points.near.addLayer(marker);
        } else if ( marker_mode == 'far' ) {
            marker.setStyle({ color: '#F00' });
            points.far.addLayer(marker);
        }

        update_search_area();
    });

    // Circle management controls.
    L.easyBar([
        // Clear all circles button.
        L.easyButton({
            id: 'clear-all',
            states: [{
                stateName: 'clear',
                icon: 'fa-trash-o',
                title: "Clear all placed markers",
                onClick: function( ) {
                    points.near.clearLayers();
                    points.far.clearLayers();
                    area.clearLayers();
                }
            }]
        }),

        // Circle color toggle button.
        L.easyButton({
            id: 'color-toggle',
            states: [{
                stateName: 'near',
                icon: 'fa-check-circle-o',
                title: "Create green markers",
                onClick: function( button ) {
                    marker_mode = 'near';
                    button.state('far');
                }
            }, {
                stateName: 'far',
                icon: 'fa-times-circle-o',
                title: "Create red markers",
                onClick: function( button ) {
                    marker_mode = 'far';
                    button.state('near');
                }
            }]
        }),

        // Place a circle at your current location.
        L.easyButton({
            id: 'place-here',
            states: [{
                stateName: 'place',
                icon: 'fa-arrow-circle-o-down',
                title: "Place a marker at your location",
                onClick: function( ) {
                    if ( me.getLayers().length < 1 ) {
                        return;
                    }
                    map.fire('click', { latlng: me.getLayers()[0].getLatLng() });
                }
            }]
        }),
    ], { position: 'topright' }).addTo(map);

    // About dialog.
    L.easyButton({
        id: 'about',
        position: 'bottomleft',
        states: [{
            stateName: 'about',
            icon: 'fa-question-circle-o',
            title: 'About this app',
            onClick: function( button ) {
                map.openModal({ content: document.getElementById('about-dialog').outerHTML });
            }
        }]
    }).addTo(map);
    </script>
</body></html>
